# access control and privilege escalation vulnerabilities
### flow
* privilege escalation
* types of vulnerabilities that may arise with access control
* how to prevent access control vulnerabilities
### access control
* application of constraints on who or what is authorised to perform actions or access resources
* in the context of web applications, access control is dependent on authentication and session management
    - authentication &rarr; confirms that the user is who they say they are
    - session management &rarr; identifies which subsequent HTTP requests are being made by that same user
    - access control &rarr; determines whether the user is allowed to carry out the action that they are attempting to perform
* broken access controls are common and often present a critical security vulnerability
* design and management of access controls is a complex and dynamic problem that applies business, organisational and legal constraints to a technical implementation
* access control design decisions have to be made by humans so the potential for errors is high
### types of vulnerabilities
##### vertical access controls
* mechanisms that restrict access to sensitive functionality to specific types of users
* different types of users have access to different application functions
    - example: an administrator might be able to modify or delete any user's account; an ordinary user has no access to these actions
* vertical access controls can be more fine-grained implementations of security models designed to enforce business policies such as separation of duties and least privilege
##### horizontal access controls
* mechanisms that restrict access to resources to specific users
* different users have access to a subset of resources of the same type
    - example: a banking application will allow a user to view transactions and make payments from their own accounts but not the accounts of any other user
##### context-dependent access controls
* restrict access to functionality and resources based on the state of the application or the user's interaction with it
* prevent a user performing actions in the wrong order
    - example: a retail website may prevent users from modifying the contents of their shopping cart after they have made payment
##### examples of broken access controls
* vertical privilege escalation &rarr; if a user can gain access to functionality that they are not permitted to access then this is vertical privilege escalation
    * example: a non-administrative user can gain access to an admin page where they can delete user accounts
    * unprotected functionality &rarr; arises where an application does not enforce any protection for sensitive functionality, for example, administrative functions might be linked from an administrator's welcome page but not from a user's welcome page
        - however, a user might be able to access the administrative functions by browsing to the relevant admin URL
        - example: a website might host sensitive functionality at the following URL: `https://insecure-website.com/robots.txt`
        - this might be accessible by any user, not only administrative users who have a link to the functionality in their user interface
        - in some cases, the administrative URL might be disclosed in other locations, such as the `robots.txt` file
        - even if the URL is not disclosed anywhere, an attacker may be able to use a wordlist to brute-force the location of the sensitive functionality
        - there are cases where sensitive functionality is concealed by giving it a less predictable URL; this is an example of so-called ***"security by obscurity"***, however, hiding sensitive functionality does not provide effective access control because users might discover the obfuscated URL in a number of ways
        - picture an application that hosts administrative functions at the following URL: `https://insecure-website.com/administrator-panel-yb556`
        - an attacker might not be directly guess this,  however, the application might still leak the URL to users
        - the URL might be disclosed in JavaScript that constructs the user interface based on the user's role viz:

            ```javascript
                <script>
                    var isAdmin = false;
                    if (isAdmin) {
                        ...
                        var adminPanelTag = document.createElement('a');
                        adminPanelTag.setAttribute('https://insecure-website.com/administrator-panel-yb556');
                        adminPanelTag.innerText = 'Admin panel';
                        ...
                    }
                </script>
            ```

        - this script adds a link to the user's UI if they are an admin user, however, the script containing the URL is visible to all users regardless of their role 
    * parameter-based access control methods
        -  some applications determine the user's access rights or role at login and then store this information in a user-controllable location
        - this could be: a hidden field, cookie or preset query string parameter
        - the application makes access control decisions based on the submitted value
        - example: `https://insecure-website.com/login/home.jsp?admin=true` or `https://insecure-website.com/login/home.jsp?role=1` etc
        - this approach is insecure because a user can modify the value and access functionality they are not authorised to such as administrative functions
    * broken access control resulting from platform misconfiguration
        -  some applications enforce access controls at the platform layer
        - they do this by restricting access to specific URLs and HTTP methods based on the user's role
        - example: an application might configure a rule as follows

            ```text
                DENY: POST, /admin/deleteUser, managers
            ```

        - this rule denies access to the `POST` method on the URL `/admin/deleteUser` for users in the `managers` group; various things can go wrong in this situation leading to access control bypasses (example: a `manager` user may send a `PUT`, `PATCH` or `DELETE` request instead)
        - some application frameworks support various non-standard HTTP headers that can be used to override the URL in the original request such as `X-Original-URL` and `X-Rewrite-URL`
        - if a website uses rigorous front-end controls to restrict access based on the URL but the application allows the URL to be overridden via a request header, then it might be possible to bypass the access controls using a request like the following:

            ```text
                POST / HTTP/1.1
                X-Original-URL: /admin/deleteUser
                ...
            ```

        - an alternative attack relates to the HTTP method used in the request; the front-end controls described in the previous sections restrict access based on the URL and HTTP method
        - some websites tolerate different HTTP request methods when performing an action, therefore, if an attacker can use the `GET` (or another) method to perform actions on a restricted URL, they can bypass the access control that is implemented at the platform layer
    * broken access control resulting from URL-matching discrepancies
        - websites can vary in how strictly they match the path of an incoming request to a defined endpoint
        - example: they may tolerate inconsistent capitalisation, therefore, a request to `/ADMIN/DELETEUSER` may still be mapped to the `/admin/deleteUser` endpoint
        - if the access control mechanism is less tolerant, it may treat these as two different endpoints and fail to enforce the correct restrictions as a result
        - similar discrepancies can arise if developers using the Spring framework have enabled the `useSuffixPatternMatch` option: this allows paths with an arbitrary file extension to be mapped to an equivalent endpoint with no file extension
        - in other words, a request to `/admin/deleteUser.anything` would still match the `/admin/deleteUser` pattern
        - prior to Spring 5.3, this option is enabled by default
        - on other systems, you may encounter scenarios where `/admin/deleteUser` and `/admin/deleteUser/` are treated as distinct endpoints; in this case, you may be able to bypass access controls by appending a trailing slash to the path
* horizontal privilege escalation
    - occurs when a user is able to gain access to resources belonging to another user instead of their own resources of that type
    - example:  an employee can access the records of other employees as well as their own
    - may use similar types of exploit methods to vertical privilege escalation
    - example: a user might access their own account page using the following URL: `https://insecure-website.com/myaccount?id=123`
    - if an attacker modifies the `id` parameter value to that of another user, they might gain access to another user's account page and the associated data and functions
    > the example above is also an example of an insecure direct object reference (IDOR) vulnerability. this type of vulnerability arises where user-controller parameter values are used to access resources or functions directly
    - in some applications, the exploitable parameter does not have a predictable value
    - example: instead of an incrementing number, an application might use globally unique identifiers (GUIDs) to identify users. this may prevent an attacker from guessing or predicting another user's identifier, however, the GUIDs belonging to other users might be disclosed elsewhere in the application where users are referenced such as user messages or reviews
    - in some cases, an application detects when the user is not permitted to access the resource and returns a redirect to the login page, however, the response containing the redirect might include some sensitive data belonging to the targeted user, therefore, the attack is successful
* horizontal-to-vertical privilege escalation
    - a horizontal privilege escalation attack can be turned into a vertical privilege escalation by compromising a more privileged user
    - example: a horizontal escalation might allow an attacker to reset or capture the password belonging to another user
    - if the attacker targets an administrative user and compromises their account, then they can gain administrative access and so perform vertical privilege escalation
    - an attacker might be able to gain access to another user's account page using the parameter tampering technique already described for horizontal privilege escalation: `https://insecure-website.com/myaccount?id=456`
    - if the target user is an application administrator, then the attacker will gain access to an administrative account page. this page might disclose the administrator's password,  provide a means of changing it or might provide direct access to privileged functionality
* insecure direct object references (IDORs) &rarr; a subcategory of access control vulnerabilities
    - IDORs occur when an application uses user-supplied input to access objects directly and an attacker can modify the input to obtain unauthorised access
    - it was popularised by its appearance in the OWASP 2007 Top Ten
    - it is simply one example of many implementation mistakes that can provide a means to bypass access controls
##### access control vulnerabilities in multi-step processes
* websites implement important functions over a series of steps
* this is common when:
    - variety of inputs or options need to be captured
    - the user needs to review and confirm details before the action is performed
* example: the administrative function to update user details might involve the following steps:
    1. load the form that contains details for a specific user
    2. submit the changes
    3. review the changes and confirm
* at times, a website will implement rigorous access controls over some of these steps but ignore others
    - picture a website where access controls are correctly applied to the first and second steps but not to the third step: the website assumes that a user will only reach step 3 if they have already completed the first two steps which are properly controlled
    - an attacker can gain unauthorised access to the function by skipping the first two steps and directly submitting the request for the third step with the required parameters
##### referrer-based access control
* some websites base access controls on the `Referer` header submitted in the HTTP request
* said header can be added to requests by browsers to indicate which page initiated a request
    - example: an application robustly enforces access control over the main administrative page at `/admin` but for sub-pages such as `/admin/deleteUser` only inspects the `Referer` header
    - if the `Referer` header contains the main `/admin` URL, then the request is allowed
    - in this case, the `Referer` header can be fully controlled by an attacker: this means that they can forge direct requests to sensitive sub-pages by supplying the required `Referer` header and gain unauthorised access
##### location-based access control
* some websites enforce access controls based on the user's geographical location
* this can apply, for example, to banking applications or media services where jurisdictional legislation or business restrictions apply
* these access controls can often be circumvented by the use of web proxies, VPNs or manipulation of client-side geolocation mechanisms
* ever watch netflix shows that you should not be watching based on your location? 
    - [megatron's][def] voice: yes, yes...
    <img src="./megatron-yes.jpeg" alt="megs"/>
### how to prevent access control vulnerabilities
* access control vulnerabilities can be prevented by taking a defence-in-depth approach and applying the following principles:
    - do not rely on obfuscation alone for access control
    - unless a resource is intended to be publicly accessible, deny access by default
    - wherever possible, use a single application-wide mechanism for enforcing access controls
    - at the code level, make it mandatory for developers to declare the access that is allowed for each resource and deny access by default
    - audit and test access controls thoroughly to ensure they work as designed


[def]: https://tfwiki.net/wiki/Megatron_(BW)