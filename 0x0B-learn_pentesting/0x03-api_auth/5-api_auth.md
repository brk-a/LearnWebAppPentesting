# APIs and gateways
#### flow
* gateways
* gateways and API interactions
* how tokens are used in the context of gateways and APIs
### gateways
* [more info][def]
* a gateway is a node/device at the edge of a network that allows said network to access or be accessed by another through a transmission protocol
    - said networks do not necessarily have to use the same networking protocol; the gateway is network-agnostic and/or protocol-
    - said gateway can be configured to accept specific requests/protocols etc
* provide a layer of protection for APIs because they are the first point of contact for all incoming requests
* are security-focused. it is in the name; the gateway is a gate that can be configured to allow specific requests/protocols etc
* reduce visibility of exposed APIs because they are place in front of the API
* make sure that the network cannot be directly accessed
* are a security feature e.g. layer 7 firewalls
##### gateways and OAuth
* a gateway, typically, terminates incoming requests, inspects them and decides whether to drop or forward them
    - in the case of forwarding, it decides where each request will be forwarded
* said gateway will terminate the request, retrieve the token, send said token to the AS, analyse the response from the AS and decide whether or not to drop or forward the request to the right endpoint when OAuth is enabled/configured into the system
    - said tokens are, preferably, by-reference tokens
* phantom token flow 
    - recall that the token in the request is a by-reference token and the  response from the AS is in JSON format. what does the gateway do?
    - glad you asked... the gateway fashions a request to the AS that causes a by-value token to be issued by the AS
    - the gateway forwards an opaque token to the AS; AS responds with a by-value token, example, JWT
    - said by-value token is forwarded to the RS (the API)
    - in other words, the gateway facilitates the conversion of a by-reference token to a by-value one
    - said flow and conversion is useful for audit purposes
* all APIs must depend on JWTs
    - accept no request w/o a JWT
    - verify issuer, audience, validity, scope and claims
    - uniform security model internally
    - easy re-use of validation logic
    - zero-trust is enabled/in-built y default
    - identity data is kept and can be used at API level
### gateway and API interactions
#### 1. introspection
* [more info][def2]
* gateway accepts incoming requests
* gateway receives an opaque token (by-reference token) from said incoming request
* gateway sends a `POST` request to the `/introspection` endpoint on the AS
    - two ways: 
        - have the `Accept` attribute set to `application/jwt`. response is in JSON format. the token will be a JSON response

            ```text
                {
                    ---snip---
                    "jwt": "ey...",
                    ---snip---
                }
            ```
        - fail to have the `Accept` attribute. the token will be a key in the JSON response

            ```mermaid
            ---
            title: introspection
            ---
                %%{init: {"flowchart": {"htmlLabels": false}} }%%
                flowchart TD
                a[gateway]--> |"`POST /introspection<br/>Content-Type: application/x-www-form-urlencoded<br/>"client_id"=GATEWAY_CLIENT_ID<br/>&client_secret=v3rRY5eRrC3t<br/>&token=ASDFGH`"|b[AS]
                b--> |"`{<br/>"sub":"testuser"<br/>"purpose":"access_token"<br/>"iss":"hxxps://issuer.example.co.ke"<br/>"active":"true"<br/>"token_type":"bearer"<br/>"client_id":"client-1"<br/><br/>"aud":"api123"<br/><br/>"nbf":1542701337<br/><br/>"scope":"read"<br/>"exp":1542701337<br/>"delegationId":"b9ecda48-e7a3-4915-9e5c-e9c5dee65a1"<br/>"iat":1542701337<br/>}`"|a
            ```

    - third method: token exchange. gateway sends a token to AS and AS returns a by-value token to gateway

          ```mermaid
            ---
            title: introspection
            ---
                %%{init: {"flowchart": {"htmlLabels": false}} }%%
                flowchart TD
                a[gateway]--> |"`POST /token<br/>Content-Type: application/x-www-form-urlencoded<br/>"client_id"=GATEWAY_CLIENT_ID<br/>&client_secret=v3rRY5eRrC3t<br/>&grant_type=urn:ietf:params:oauth:grant-type:token-exchange<br/>&subject_token=ASDFREWQ&subject_token_type=urn:ietf:params:oauth:token-type:access_token<br/>&requested_token_type=urn:ietf:params:oauth:grant-type:jwt`"|b[AS]
                b--> |"`{<br/>"sub":"testuser"<br/>"purpose":"access_token"<br/>"iss":"hxxps://issuer.example.co.ke"<br/>"active":"true"<br/>"token_type":"bearer"<br/>"client_id":"client-1"<br/><br/>"aud":"api123"<br/><br/>"nbf":1542701337<br/><br/>"scope":"read"<br/>"exp":1542701337<br/>"delegationId":"b9ecda48-e7a3-4915-9e5c-e9c5dee65a1"<br/>"iat":1542701337<br/>}`"|a
            ```

#### 2. API-to-API calls
* say the request from a user has gone through the introspection process and that the gateway has an access and/or session token
* gateway redirects request to the correct API
* say the request requires data from another API
    - we have a situation where an API calls another API
    - how do we communicate the access and/or session token to the other API?
    - say we go down N levels \[of contrivance\]; shall we repeat the introspection process every time?
* TL;DR:
    - we communicate the access and/or session token inthree ways: exchange, embed or share
    - yes and no depending on implementation
* exchange, embed, share...
    - exchange &rarr; use token exchange to get another token
        - API talks to the AS in order to get a token; here the API is a client, not a RS
        - tokens are issued on demand
        - powerful options (customisable)
    - embed &rarr; put more tokens inside the first token
        - token given to gateway by AS has a claim to access the API in question
        - here the API is a RS; the first API is a client of sorts
        - the first API uses said claim to access the second API
        - use this when you know that the N<sup>th</sup>+1 API is called every time the N<sup>th</sup> API is called
    - share &rarr;use the same token everywhere (least recommended)
        - one token; multiple access
        - not very secure, now, is it?
        - use this when APIs are in the same security domain
* exchange vs embed
    - exchange gets token on demand; embed places token in the first token
    - exchange assumes zero trust by default; embed does not
    - exchange is great for bespoke or non-recurring transactions; embed is great for recurring transactions
#### 3. APi authorisation(s)
* 13:00

[def]: https://www.geeksforgeeks.org/introduction-of-gateways/
[def2]: https://www.rfc-editor.org/rfc/rfc7662