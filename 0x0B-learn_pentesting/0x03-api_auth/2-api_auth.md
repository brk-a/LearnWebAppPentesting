# OAuth interaction patterns
1. ### OAuth code flow
* uses all the actors (see [1-api_auth.md][def])
* the AS has two endpoints exposed: `authorise` and `token`
    - implementations are system and developer-specific
* how it works
    - user (RO) visits a website/app (client)
    - client calls `authorise` endpoint

        ```text
            GET /authorise

            ?response_type=code
            &client_id=myApp
            &scope=read
            &code_challenge=MY_CHALLENGE
            &code_challenge_method=S256
            &state=MY_RANDOM_STATE
        ```

    - AS redirects request to an authentication or federation service
    - authetication/federation service authenticates the client (RO uses a uname-passwd combination, 2FA etc. RO can reset password or get a [magic link][def2] etc)
    - `authorise` endpoint on AS redirects response from authentication/federation service to the client (response is sent to a pre-defined `callback` endpoint on the client)

        ```text
            303 /callback

            ?code=1234
            &state=MY_RANDOM_STATE
        ```

    - client makes a back-channel call using `POST` method to `token` endpoint on AS

        ```text
            POST /token
            Content-Type: application/x-www-form-urlencoded

            grant_type=authorisation_code
            &client_id=myApp
            &client_secret=v3RrYs3cRE7
            &code_verifier=MY_VERIFIER
            &code=1234
        ```

    - AS, through the `token` endpoint, responds with an access and refresh token when it verifies that authentication was successful, else, drops the request

        ```json
            {
                "access_token":"ABCDEFG",
                "scope":"read",
                "expires_in":300,
                "refresh_token":"HIJKLM",
                "token_type":"bearer"
            }
        ```

    - client stores the refresh token and uses the access token to query the RS

        ```mermaid
        ---
        title: OAuth flow
        ---
            flowchart LR
            A[RO]--> |visits|B[client]
            B--> |call `/authorise`|C[AS]
            C--> |redirects|D[authentication/federation service]
            D--> |authentication successful|C
            C--> |call `/callback`|B
            B--> |send back-channel request to `/token`|C
            C--> |authentication is successful: refresh and access tokens|B
            B--> |access token|E[RS]
            C--> |authentication is not successful: drop|F[drop request]
            D--> |authentication is not successful: drop|F[drop request]
        ```

* the refresh (aka session) token is used to get another access token. access tokens are, by definition, short-lived, therefore, there must be a way to refresh the token; this is why the refresh token is required
    - the AS issues new tokens as long as the refresh token is valid
    - client sends a request to the `/token` endpoint

        ```text
            POST /token
            Content-Type: application/x-www-form-urlencoded

            grant_type=refresh_token
            &client_id=myApp
            &client_secret=v3RrYs3cRE7
            &refresh_token=HIJKLM
        ```

    - AS responds w. an access and refresh token (if refresh token is valid AS responds w. a new access token immediately. the refresh token may or may not change depending on the configuration of the system)

        ```json
            {
                "access_token":"NOPQRS",
                "scope":"read",
                "expires_in":300,
                "refresh_token":"HIJKLM",
                "token_type":"bearer"
            }
        ```

2. ### OAuth client credentials flow
* more or less follows the code flow except the following
    - `grant_type` i the `POST` request to `token` is `client_credentials`; this supports batch jobs, cron jobs, APIs calling other APIs etc. in other words, users that are not ROs by definition
    - `token` endpoint operates in ***client_credentials*** mode
    - the response body from `token` endpoint has no session token

        ```json
            {
                "access_token":"NOPQRS",
                "scope":"read",
                "expires_in":300,
                "token_type":"bearer"
            }
        ```

    - 

[def]: ./1-api_auth.md
[def2]: https://www.okta.com/blog/2020/09/magic-links/