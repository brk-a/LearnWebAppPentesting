# scopes and claims
### scopes
* scope of access; defines what a client or app should access
* scope is a key, not a value
    - simply a string
    - examples: `read`, `openid`, `user_invoice_update`, `user_invoice_read` etc
* requested by the client
    - must be pre-approved, however, so that the client can request them
* consented, sometimes, by the RO
* authorised by AS
* used to express client privileges, not user-level privileges
#### user/RO consent
* scopes involve the user/RO
* user can, optionally, consent to giving the application/client access
* sometimes useful in 3<sup>rd</sup> party cliet orgs
* on the UI, this may appear as a modal asking the user to consent to the application/client or not
* this comes from the AS and AS server only
#### why scope is useful
* example: consumer client wants to access the resource at the endpoint `/invoices/123` on the RS
    - client requests `user_invoice_read` scope  from AS
    - AS grants scope to the client in the access token
    - client sends a `GET` request to `/invoices/123`
    - client reads the resource at the endpoint `/invoices/123`
* what happens when said client wants to update or delete the resource at the endpoint `/invoices/123`?
    - TL;DR: client cannot do that at all because the ***update*** and ***delete*** scopes are not granted to the client
    - say we have another client who is a back-office client (finance department, maybe)
    - this client wants to read and write the resource at the endpoint `/invoices/{invoice_id}`
    - in this example, the AS will grant `user_invoice_update` scope to said client
    - client sends a `POST` request to `/invoices/123`
    - client can read and write the resource at the endpoint `/invoices/123`
* notice how the same RS is many things to many clients

    ```mermaid
    ---
    title: scope
    ---
        flowchart LR
        a[AS]--> |scope=user_invoice_read|b[consumer client]
        a--> |scope=user_invoice_update|c[back-office client]
        b--> |GET /invoices/123|d[RS]
        c--> |POST /invoices/123|d
    ```

* notice how there is nothing to tell the RS that a holder of a token truly has the scope they claim to have; this is where claims come in
### claims
* claims are key-value items

    ```json
        {
            "subject": "Goat Matata",
            "profession": "podcast bro",
            "workspace": "The GOAT Podcast",
            "title": "CEO",
        }
    ```

* are in the body of the token
* asserted by the issuer (usually the AS)
    - issuer looks up info about the user/client/recipient and puts that in the token
* claim the truth abouth the subject
    - info in the claim is considered to be true beacuse it is assumed to be from a single source of truth
* may be used to enforce fine-grained access control
    - user-level access control, for example
* example

    ```json
        {
            "jti": "5d064d3a-58bd-4b78-8a14-763ae6f7ac6",
            "delegationID": "b9ecda48-e7a3-4915-9e5c-e9c5dee65a1",
            "exp": "1712066897",
            "nbf": "1712066897",
            "scope": "openid update",
            "iss": "hxxps://www.goatmatata.co.ke/login/oauth/m",
            "sub": "Goat Matata",
            "profession": "podcast bro",
            "workspace": "The GOAT Podcast",
            "title": "CEO",
            "aud": [
                "client_one",
                "audience2",
            ],
            "iat": "1712066897",
            "purpose": "access_token"
        }
    ```

#### access token claims
* may be the API for your API
* are the single source of trut for identity data
* help you avoid external calls from the API
* design a common identity API for your APIs
* can be different depending on the scopes in the token
* data that goes into the token must fit these criteria
    - relevant to a large set of your APIs (resources)
    - not be application-specific
    - be an attribute of the user, that is, closely coupled with the user (client)
    - should not be contextual to the session
### scope and claim hierarchy
* openID connect defines scope-to-claim mappings
    -  `email` scope allows `email` and `email_verified` claims to be issued

        ```text
        {
            ---snip---
            "email": "dadangombe@chizicheese.co.ke",
            "email_verified": true,
            ---snip---
        }
        ```
    
    - `address` scope has a number of claims

        ```text
            ---snip---
            "formatted": "whatever",
            "street_address": "123 Emara Plateau",
            "locality": "Ewaso Nyiro",
            "region": "Engare Naro",
            "postal_code": "12345",
            "country": "Kenya",
            ---snip---
        ```

    - more examples

        ```text
            ---snip---
            "scope": "invoice_read",
            "subscriber_id": "1ac32b4d",
            "cost_centre": "fabrication"
            ---snip---
        ```


        ```text
            ---snip---
            "scope": "invoice_write",
            "subscriber_id": "1ac32b4d",
            "cost_centre": "fabrication",
            "department": "manufacturing"
            ---snip---
        ```

        ```text
            ---snip---
            "scope": "video_stream",
            "subscription_level": "gold",
            "age": 29
            ---snip---
        ```

    - 
