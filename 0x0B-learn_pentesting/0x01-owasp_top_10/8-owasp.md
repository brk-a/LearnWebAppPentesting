# API8:2023 security misconfiguration
* a catch-all for many vulnerabilities related to the systems that host APIs
* it can be detrimental to the confidentiality, integrity and availability of an API provider's data when said API's security is misconfigured
* the impacts of an exploited security misconfiguration can range from information disclosure to data breach
### OWASP attack vector description
* attackers look for unpatched flaws, common endpoints or unprotected files and directories to gain unauthorised access or knowledge of the system
### OWASP security weakness description
* security misconfiguration happens at any level of the API stack: from the network level to the application level
* automated tools are available to detect and exploit misconfigurations such as unnecessary services or legacy options
### OWASP impacts description
* security misconfigurations not only expose sensitive user data but also system details that can lead to full server compromise
### OWASP preventative measures
* API life cycle should include:
    - repeatable hardening process for fast and easy deployment of a properly locked-down environment
    - task to review and update configurations across the entire API stack. said review should include: orchestration files, API components and cloud services (e.g. S3 bucket permissions)
    - an automated process to continuously assess the effectiveness of the configuration and settings in all environments
* ensure that all API communications from the client to the API server and any downstream/upstream components happen over an encrypted communication channel (TLS) whether or not it is an internal or public-facing API
* be specific about which HTTP verbs each API can be accessed by: all other HTTP verbs should be disabled (e.g. HEAD)
* APIs expecting to be accessed from browser-based clients (e.g., WebApp front-end) should at least:
    - implement a proper Cross-Origin Resource Sharing (CORS) policy
    - include applicable security headers
* restrict incoming content types/data formats to those that meet the business/ functional requirements
* ensure all servers in the HTTP server chain (e.g. load balancers, reverse and forward proxies and back-end servers) process incoming requests in a uniform manner to avoid desync issues
* where applicable, define and enforce all API response payload schemas, including error responses, to prevent exception traces and other valuable information from being sent back to attackers
### more ...
* security misconfigurations include all the mistakes that API providers make w/i the supporting systems of an API
    - security misconfigurations are, really, a set of weaknesses that includes misconfigured headers, misconfigured transit encryption, the use of default accounts, the acceptance of unnecessary HTTP methods, a lack of input sanitisation and verbose error messaging
    - example: the API's supporting security configuration reveals an unpatched vulnerability. there is a chance that an attacker may leverage a published exploit to easily `pwn` the API and its system
* litte to no input sanitisation allows attackers to upload malicious payloads to the server
    - APIs often play a key role in automating processes, therefore, picture being able to upload payloads that the server automatically processes into a format that may be remotely executed or executed by an unsuspecting end-user; fun, innit?
    - example: an upload endpoint is used to pass uploaded files to a web directory. it may allow the upload of a script; a user that navigates to the URL where the file is located may launch the script resulting in direct shell access to the web server
    * also, a lack of input sanitisation can lead to atypical behaviour on the part of the application
* API providers use headers to provide the consumer with instructions for handling the response and security requirements
    - misconfigured headers result in sensitive information disclosure, downgrade attacks and cross-site scripting attacks
    - many API providers will use additional services alongside their API to enhance API-related metrics or to improve security
    - it is fairly common that those additional services will add headers to requests for metrics and perhaps as some level of assurance to the consumer
* example: unleash [nikto][def] on a test api, say, `http://crapi.apisec.ai`

    ```text
        $ nikto -h http://crapi.apisec.ai
        - Nikto v2.1.6
        ----------------------------------------------------
        + Target IP:        20.230.217.15
        + Target Hostname:  crapi.apisec.ai
        + Target port:      80
        + Start Time:       2024-07-20 10:21:15 (GMT+3)
        ----------------------------------------------------
        + Server: openresty/1.17.8.2
        + IP address found in the 'server' header. The IP is "1.17.8.2"
        + The anti-clickjacking X-Frame-Options header is not present
        + The X-XSS-Protection header is not defined. This header can hint to the user agent to protect against some forms of XSS
        + The X-Content-Type-Options header is not set. This could allow the user agent to render the content of the site in a different fashion to the MIME type
        + No CGI Directories found (use '-C all to force check all possible dirs)
        + /20.230.217.15.pem: Potentially interesting archive/cert file found.
        + /20.230.217.15.pem: Potentially interesting archive/cert file found. (NOTE: requested by IP address)
        + /20.230.217.15.cer: Potentially interesting archive/cert file found.
        + /20.230.217.15.cer: Potentially interesting archive/cert file found. (NOTE: requested by IP address)
    ```
* the `X-Powered-By` header reveals backend technology
    - headers like this one often advertise the specific supporting service and its version
    - you may use information like this to search for exploits published for that version of software
* `X-XSS-Protection` is exactly what it looks like: a header meant to prevent cross-site scripting (XSS) attacks
    - XSS is an injection vulnerability where an attacker inserts scripts into a web page and tricks end-users into clicking on malicious links
    - a X-XSS-Protection value of 0 indicates no protections in place and a value of 1 indicates that the protection is turned on
    - this header, and others like it, clearly reveals whether or not a security control is in place
* the `X-Response-Time` header is middleware that provides usage metrics
    - in the example above, its value represents 566.43 milliseconds, however, if the API is not configured properly, this header can function as a side-channel used to reveal existing resources
    - say the X-Response-Time header has a consistent response time for non-existing records, for example, but increases its response time for certain other records. this may be an indication that those records exist
    - say, for instance, an attacker can determine that a bogus account, `/user/account/thisdefinitelydoesnotexist`, has an average X-Response-Time of 25.5 ms. say the attacker also knows that an existing account, `/user/account/1021`, receives an X-Response-Time of 510.00. said attacker may send requests to brute-force account numbers and review the results to see which account numbers resulted in drastically increased response times
* any API that provides sensitive information to consumers should use Transport Layer Security (TLS) to encrypt the data even if the API is only provided internally, privately or at a partner level. TLS, the protocol that encrypts HTTPS traffic, is a basic/trivial way to ensure that API requests and responses are protected when being passed across a network
* misconfigured or missing transit encryption causes API users to pass sensitive API information in cleartext across networks in which case an attacker may capture the responses and requests using a Man-in-the-Middle (MITM) attack and read them plainly. they would, simply, have to intercept the network traffic with a network protocol analyser, say, Wireshark, to see the information being communicated between a consumer and a provider
* an attacker may use an account's credentials to assume the role of said account when a service uses default accounts or credentials and the defaults are known
    - this allows them to gain access to sensitive information or administrative functionality and potentially lead to a compromise of the supporting systems
* if an API provider allows unnecessary HTTP methods, there is an increased risk that the application will not handle these methods properly or will result in sensitive information disclosure

[def]: https://www.kali.org/tools/nikto/