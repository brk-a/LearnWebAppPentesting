# API9:2023 improper inventory management
* the risks involved with exposing non-production and unsupported API versions
* non-production and unsupported versions of the API are, often, not protected by the same security rigour as the production versions 
    - this makes improper inventory management a gateway to other API security vulnerabilities
### OWASP attack vector description
* threat agents get unauthorised access through any combination of the following:
    - old API versions/endpoints left running unpatched 
    - old API versions/endpoints that use weaker security requirements
* they may, also, get access to sensitive data through a 3<sup>rd</sup> party with whom there is no reason to share data with
### OWASP security weakness description
* outdated documentation makes it difficult to find and/or fix vulnerabilities because, well, the documentation is outdated
* w/o an assets inventory and retirement strategy, you risk running unpatched systems. this results in leakage of sensitive data among other horrors
* it is common to find unnecessarily exposed API hosts because of modern concepts, say, microservices; these make applications easy to deploy and independent (e.g. cloud computing, K8S), however, simple google dorking, DNS enumeration or specialised search engines for various types of servers (webcams, routers, servers etc.) connected to the internet will be enough to discover targets
### OWASP impacts description
* attackers gain access to sensitive data or even take over the server
* different API versions/deployments are, at times, connected to the same database with real data: threat agents may exploit deprecated endpoints available in old API versions to get access to administrative functions or exploit known vulnerabilities
### OWASP preventative measures
* create an inventory of all API hosts and document important aspects of each one of them
    - focus on:
        - the API environment (e.g. production, staging, test and development)
        - who should have network access to the host (e.g., public, internal, partners)
        - the API version
* create an inventory of integrated services and document important aspects such as their role in the system: what data is exchanged (data flow) and its sensitivity
* document all aspects of your API such as authentication, errors, redirects, rate limiting, cross-origin resource sharing (CORS) policy and endpoints. include their parameters, requests and responses
* generate documentation automatically by adopting open standards. include the documentation build in your CI/CD pipeline
* make API documentation available to those authorised to use the API
* use external protection measures such as API security firewalls for all exposed versions of your APIs, not just for the current production version
* avoid using production data with non-production API deployments. if this is unavoidable, these endpoints should get the same security treatment as the production ones
* perform risk analysis to make the decision of the mitigation actions required for the older version when newer versions of APIs include security improvements
    - example: whether or not it is possible to back-port the improvements without breaking API compatibility
    - example: do you need to take the older version out quickly and force all clients to move to the latest version?
### more ...
* improper inventory management takes place when an organisation exposes APIs that are unsupported or still in development
    - old API versions are more likely to contain vulnerabilities because they are no longer being patched and upgraded
    - APIs that are in development are, typically, not as secure as their production API counterparts
* improper inventory management leads to other vulnerabilities such as: excessive data exposure, information disclosure, mass assignment, improper rate-limiting and API injection
    - for attackers, this ~~is paradise~~ means that discovering an improper inventory management vulnerability is the first step ~~to paradise~~ toward further exploitation of an API
* improper inventory management may be tested by using outdated API documentation, changelogs and version history on repositories
    - example: an organisation’s API documentation has not been updated along with the API’s endpoints; it may contain references to portions of the API that are no longer supported etc
    - organisations, often, include versioning information in their endpoint names to distinguish between older and newer versions such as `/v1/`, `/v2/`, `/v3/` and so on 
    - APIs in development often use paths such as `/alpha/`, `/beta/`, `/test/`, `/uat/` and `/demo/`
    - an attacker that knows that an API is now using `apiv3.org/admin` but part of the API documentation refers to `apiv1.org/admin` may test different endpoints to see if `apiv1` or `apiv2` is still active
    - the organisation’s changelog may disclose the reasons why `v1` was updated or retired; an attacker that has access to v1 can test for those weaknesses
* other than documentation, an attacker may discover improper inventory vulnerabilities through the use of guessing, fuzzing or brute force requests
    - testing for improper assets management is all about discovering unsupported and non-production versions of an API; API providers will, often, update services and the newer version of the API will be available over a new path viz:

    ``` text
        api.target.com/v3
        /api/v2/accounts
        /api/v3/accounts
        /v2/accounts
    ```

    - API versioning may be maintained as a header viz:

    ```text
        Accept: version=2.0
        Accept api-version=3
    ```

    - versioning may be set within a query parameter or request body viz:

    ```text
        /api/accounts?ver=2
        POST /api/accounts

        {
            "ver":1.0,
            "user":"goatmatata"
        }
    ```

* non-production versions of an API include any version of the API that was not meant for end-user consumption. non-production versions may include:

    ```text
        api.test.target.com
        api.uat.target.com
        beta.api.com
        /api/private
        /api/partner
        /api/test
    ```

* in these instances, earlier versions of the API may no longer be patched or updated
    - since the older versions lack this support, they may expose the API to additional vulnerabilities and lead an attacker to a path that can be used to compromise the provider's data

