# CORS
* cross-origin resourse sharing
* a set of browser controls set by web servers
    - sits in the browser
    - implements controls set by web servers/APIs
* defines what responses are allowed from where
    - what: endpoints, methods (HTTP verbs) etc
    - where: UI
    - more:
        - origins
        - credentials
        - methods
        - headers
### why use CORS?
* CORS is a basic security config for a web server
* you have an API that has something to protect
    - user data
    - intellectual property
    - branding
    - etc
### when does CORS help?
* not during direct attacks
    - at this time, CORS is like a ***this is a gun-free zone*** sign to victims of a mass shooter during an active shooting; useless
    - point being, attackers will simply ignore/faile to respect CORS 
* during access by unsuspecting users through a malicious site

    ```mermaid
    ---
    title: when CORS is useful
    ---
        flowchart LR
        a[malicious system]--> |attackers do not care about CORS|b[API]
        c[unsuspecting user]--> |accesses API through|d[malicious site]
        d--> |request is blocked by|e[CORS]
        e--x |so it never reaches|b
    ```

### common CORS scenario
* create a new server for an API
* server has basic security configs
* developer gets a `CORS allow-Origin` error from a `localhost` request/test
* developer ***"fixes"*** error by bypassing CORS
* this hole/vulnerability is propagated into production
* example: an old node.js back-end

    ```javascript
        // in terminal: npm install cors
        var express = require('express')
        var cors = require('cors')
        var app = express()

        app.use(cors())
        app.get("/products/:id", (req, res, next) => {
            res.json(msg: "this is CORS-enabled for all origins")
        })

        app.listen(80, () => {
            console.info("CORS-enabled web server listening on port 80")
        })
    ```

* how to fix it
    - set the headers; define what is allowed

    ```javascript
        // in terminal: npm install helmet
        import express from "express"
        import helmet from "helmet"


        const app = express()
        app.use(helmet())

        app.get("/", (req, res)=>{
            res.send("Hello, world!")
        })

        app.listen(8080)
    ```

    - by default, helmet set the following headers
        - `Content-Security-Policy` &rarr;  a powerful allow-list of what can happen on your page which mitigates many attacks
        - `Cross-Origin-Opener-Policy` &rarr;  helps process-isolate your page
        - `Cross-Origin-Resource-Policy` &rarr;  blocks others from loading your resources cross-origin
        - `Origin-Agent-Cluster` &rarr;  changes process isolation to be origin-based
        - `Referrer-Policy` &rarr;  controls the `Referer` header
        - `Strict-Transport-Security` &rarr;  tells browsers to prefer HTTPS
        - `X-Content-Type-Options` &rarr;  avoids MIME sniffing
        - `X-DNS-Prefetch-Control` &rarr;  controls DNS prefetching
        - `X-Download-Options` &rarr;  forces downloads to be saved (internet explorer only)
        - `X-Frame-Options` &rarr;  legacy header that mitigates clickjacking attacks
        - `X-Permitted-Cross-Domain-Policies` &rarr;  controls cross-domain behaviour for adobe products, say, acrobat
        - `X-Powered-By` &rarr;  info about the web server. removed because it could be used in simple attacks
        - `X-XSS-Protection` &rarr;  legacy header that tries to mitigate XSS attacks but makes things worse; helmet disables it