# NoSQL injection

#### what the code does
* listens for `POST` requests to the `/user` endpoint
* sees whether `username` in the body of the request matches any entry in the table `users` within the database `db`
* if match and result is valid (according to schema): return code `200` and the info about the user
* if no match or result is invalid: return code `500` and an error message 

#### what TF is NoSQL injection?
* SQL injection, w/o SQL
* NoSQL injection allows an attacker to inject code into commands for databases that do not use SQL queries

    ##### aside:  how SQL injection works
    * attacker exploits unsafe user input processing to modify or replace SQL queries (or other SQL statements) that the application sends to a database engine. in other words, an SQL injection allows an attacker to execute commands in the database

* NoSQL databases do not use a common query language; NoSQL query syntax is product-specific. queries are written in the programming language of the application: PHP, JS, Py, Java etc. a successful injection lets the attacker execute commands not only in the database, but also in the application itself; this can be far more dangerous
* MongoDB, an NoSQL db, uses the binary JSON (BSON) data format; it comes with a secure BSON query assembly tool. queries are represented as BSON objects (i.e. binary data); direct string injection is not possible, however, MongoDB deliberately allows applications to run JS on the server within the `$where` and `mapReduce` operations. the documentation is very clear that if this functionality is used, the developer should take care to prevent users from submitting malicious JS
#### the vulnerability
* NoSQL injection

#### why it is vulnerable
* consider this

        ```js
        //snip
        db.collection("users").find({
                "username": req.body.username,
            }, (err, result) => {
        //snip
        ```

* we check whether `username` in the table `users` contains an entry that matches `req.body.username`
* `req.body.username`, however, can be anything: string, float, function, `{"$ne": null}`, etc
* `{"$ne": null}`, by the way is a MongoDB-specific query that means _not equal to null_. said query will return every user that has a username whether or not that username matches `req.body.username`. we can, then, extract user-specific data from the dump we get

#### what now?
* prevent anyone from sending malformed queries
* check whether the type of `req.body.username` is string
* if yes: carry on; execute the query
* if no: return code `400` and an error message 