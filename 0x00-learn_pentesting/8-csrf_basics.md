# CSRF (Cross-site request forgery)

* idea is to see how CSRF works
* environment: Burp Suite (Community) on Kali Linux
* punching bag: [OWASP Juice Shop](https://owasp.org/www-project-juice-shop/)
* CSRF is an attack that forces an end-user to execute unwanted/undesired actions on an app in which they are currently authenticated 
    * two sections:
        1. cross-site --> old-fashioned XSS
        2. request forgery --> literal request forgery; manipulate `GET`, `POST`, `PUT` etc
    * undesired actions: actions that the user does not want to do or has no idea are happening
    * authenticated: user is logged in
* pre-requisite: understand how a HTML form works
* requests and/or responses can be forged depending on the action requested by the client
* attacker manipulates victim into submitting the attacker's form data to the victim's web server; the server performs actions on the attackers form data, not the client's
* start with login pages; they are vulnerable to CSRF
* the scripts you run during the auth session will appear to have been run by the client
e.g. change their password through the search input field etc. use a link shortener to create the link to send to your victim(s)

### how a HTML form works
* client requests a page (say, HTML form) from server
* server responds with page, if available
* client fill in the fields
* client sends filled form (form plus data) to server
* server authenticates and authorises the user; see difference [here](https://auth0.com/docs/get-started/identity-fundamentals/authentication-and-authorization)
* server performs requested action

### how to CSRF
* fire up Burp
* fire up Juice Shop
* on Juice Shop, create an account
    * email: _test@test.com_, passwd: _password_ (use anything you like)
* make sure that Burp captures the traffic and intercept is off; [this](./0-burp.md) might help
* change the password of the account at Juice Shop
    * passwd: _password123_ (use anything you like)
* go to `HTTP history`. it is under `Proxy` on Burp. there will be a list of requests ordered in ascending chronological order
* click on the entry at the bottom of the list (the latest one because order). its data appears in a section below the history section
* click `Request` then click `Raw`. you will see how the new password was passed to the server

~~~javascript
GET /rest/user/change-password?current=password&new=password123&repeat=password123 HTTP/1.1
Host: localhost:3000

...

Connection: close
~~~

* notice the params `current`, `new` and `repeat`; this is where CSRF comes in
* right click inside the raw request and select `Send to Repeater`
* click the `Repeater` tab on Burp
* the value of `current` is _password_; change it to _test_
* click `Go`
    * notice you get a `401/Unauthorised` response code that appears in the section on the right
    * Juice Box conducts *_authorisation_* on requests; this is good
* the value of `new` is _password123_; change it to _password_
* click `Go`
    * notice the `401/Unauthorised` response code; this time, it says thet `new` and `repeat` do not match
* set `new` and `repeat` to _pass123_
* click `Go`
    * notice the `200/OK` response code. there is a JSON object that shows the updated user

    ~~~json
    {"user":{"id": 9, "email": "test@test.com", "password": "...",
     "createdAt": "2023-05-05T03:05:22.190Z", "updatedAt": "2023-05-05T03:29:04.841Z"
    }}
    ~~~

* what happens when the `current` param and its value are not included in the request?
    * let's see
    * returns a `200/OK` response code. the JSON object has been updated too (check the value of _updatedAt_)
    * verify that it worked using the new password (_pass123_ in my case); it works
* test whether XSS works on Juice Box
    * in the search input, type the following and click `Search`

    ~~~javascript
    <script>alert("Hello, world.")</script>
    ~~~

    * an alert modal appears; it has the text _Hello, world._ Juice Box is susceptible to XSS
* now to the XSS part. create the following script

~~~javascript
<script>
xmlhttp = XMLHttpRequest;
xmlhttp.open('GET', 'http://localhost:3000/rest/user/change-password?new=passwd123&repeat=passwd123');
xmlhttp.send()
</script>
~~~

* copy and paste said script into the search input field of Juice Box
* click `Search`
    * an alert modal appears; it contains a success message
* Disclaimer: this only works when a user is logged in
